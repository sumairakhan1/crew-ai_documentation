# 17. Data Validation, Transformation & Task Execution in CrewAI


# ğŸš€ **Mastering Data Validation, Transformation & Task Execution in CrewAI**  

## ğŸ” **Introduction**  
CrewAI allows developers to build AI-driven workflows that **validate, filter, and transform data** before processing it. In this guide, we'll cover:  

âœ… **Data Format Validation** â€“ Ensuring input follows the correct format.  
âœ… **Content Filtering** â€“ Removing or flagging sensitive information.  
âœ… **Data Transformation** â€“ Formatting and standardizing data.  
âœ… **Chaining Validations** â€“ Combining multiple validation functions.  
âœ… **Custom Retry Logic** â€“ Retrying tasks when validations fail.  
âœ… **Saving Files with Auto-Directory Creation** â€“ Ensuring structured output storage.  

---

# ğŸ“Œ **Real-World Use Case: AI-Powered User Registration System**  

ğŸ”¹ Imagine you're building a **User Registration System** that collects:  
âœ” **Email Address** (must be valid).  
âœ” **Phone Number** (must be properly formatted).  
âœ” **Sensitive Information Check** (prevents users from entering passwords in public fields).  

---

# ğŸ› ï¸ **Step 1: Installing Required Libraries**  
Before we begin, make sure you have CrewAI installed:  
```sh
pip install crewai
```

---

# ğŸ“§ **Step 2: Validating Email Format**  
ğŸ“Œ **Why?** To prevent invalid email entries.  
ğŸ“Œ **How?** Using **regular expressions (regex)** to check email format.  

### **âœ… Code Example: Email Validation**  
```python
from typing import Tuple, Union
import re

def validate_email_format(result: str) -> Tuple[bool, Union[str, str]]:
    """Ensure the output contains a valid email address."""
    email_pattern = r'^[\w\.-]+@[\w\.-]+\.\w+$'
    if re.match(email_pattern, result.strip()):
        return (True, result.strip())  # âœ… Email is valid
    return (False, "Output must be a valid email address")  # âŒ Invalid email
```
### **ğŸ” Code Breakdown**
âœ” **`re.match(email_pattern, result.strip())`** â€“ Checks if the email follows a proper pattern.  
âœ” **Returns `(True, email)`** if valid, otherwise returns `(False, error message)`.  

---

# ğŸ”’ **Step 3: Filtering Sensitive Information**  
ğŸ“Œ **Why?** To ensure users do not enter passwords or sensitive data in plain text.  

### **âœ… Code Example: Content Filtering**  
```python
def filter_sensitive_info(result: str) -> Tuple[bool, Union[str, str]]:
    """Remove or validate sensitive information."""
    sensitive_patterns = ['SSN:', 'password:', 'secret:']
    
    for pattern in sensitive_patterns:
        if pattern.lower() in result.lower():
            return (False, f"Output contains sensitive information ({pattern})")  # âŒ Rejects sensitive data
    return (True, result)  # âœ… No sensitive information found
```
### **ğŸ” Code Breakdown**
âœ” **Checks for words like `"SSN:"`, `"password:"`, `"secret:"`** to flag sensitive content.  
âœ” **Returns `(False, error message)`** if found, ensuring data security.  

---

# ğŸ“ **Step 4: Normalizing Phone Numbers**  
ğŸ“Œ **Why?** To ensure all phone numbers follow a standard format: **(123) 456-7890**.  

### **âœ… Code Example: Phone Number Normalization**  
```python
def normalize_phone_number(result: str) -> Tuple[bool, Union[str, str]]:
    """Ensure phone numbers are in a consistent format."""
    digits = re.sub(r'\D', '', result)  # Remove non-digit characters
    if len(digits) == 10:
        formatted = f"({digits[:3]}) {digits[3:6]}-{digits[6:]}"
        return (True, formatted)  # âœ… Returns formatted number
    return (False, "Output must be a 10-digit phone number")  # âŒ Invalid phone number
```
### **ğŸ” Code Breakdown**
âœ” **`re.sub(r'\D', '', result)`** â€“ Removes everything except numbers.  
âœ” **Returns `(True, formatted number)`** if valid, otherwise an error.  

---

# ğŸ”— **Step 5: Chaining Multiple Validations**  
ğŸ“Œ **Why?** To apply multiple validations **sequentially**.  
ğŸ“Œ **How?** A **chain function** applies each validation step-by-step.  

### **âœ… Code Example: Combining Multiple Validations**  
```python
def chain_validations(*validators):
    """Chain multiple validators together."""
    def combined_validator(result):
        for validator in validators:
            success, data = validator(result)
            if not success:
                return (False, data)  # âŒ Stop if any validation fails
            result = data
        return (True, result)  # âœ… All validations passed
    return combined_validator

# Usage in Task
validate_contact_info = chain_validations(
    validate_email_format,
    filter_sensitive_info,
    normalize_phone_number
)
```
### **ğŸ” Code Breakdown**
âœ” **Iterates through multiple validation functions.**  
âœ” **Stops at the first failure.**  
âœ” **Passes only validated data forward.**  

---

# ğŸ”„ **Step 6: Implementing Custom Retry Logic**  
ğŸ“Œ **Why?** To retry a task **if it fails** due to incorrect input.  
ğŸ“Œ **How?** Using the **max_retries** parameter in a CrewAI task.  

### **âœ… Code Example: Custom Retry Logic**  
```python
from crewai import Task

task = Task(
    description="Generate user contact info",
    expected_output="Valid email and phone number",
    guardrail=validate_contact_info,
    max_retries=3  # ğŸ”„ Retries the task up to 3 times on failure
)
```
### **ğŸ” Code Breakdown**
âœ” **`max_retries=3`** â€“ Allows the task to retry up to **3 times** before failing.  

---

# ğŸ’¾ **Step 7: Saving Data with Auto-Directory Creation**  
ğŸ“Œ **Why?** To **store validated user data** in an organized way.  
ğŸ“Œ **How?** By **automatically creating directories** when saving output files.  

### **âœ… Code Example: Saving Valid Data to a File**  
```python
save_output_task = Task(
    description='Save validated user contact info to a file',
    expected_output='File saved successfully',
    output_file='outputs/user_contacts.txt',  # ğŸ“‚ Saves file in "outputs" folder
    create_directory=True  # âœ… Automatically creates missing directories
)
```
### **ğŸ” Code Breakdown**
âœ” **`output_file='outputs/user_contacts.txt'`** â€“ Defines the output file path.  
âœ” **`create_directory=True`** â€“ Ensures the directory exists before saving.  

---

# ğŸš€ **Final Crew Execution: User Registration System**  

Now, let's **combine everything** into a **CrewAI system** that validates, filters, and stores user data.

### **âœ… Full Code Example**
```python
from crewai import Crew

# ğŸ‘¥ Create Crew
user_registration_crew = Crew(
    tasks=[task, save_output_task],
    verbose=True
)

# ğŸš€ Execute Crew
result = user_registration_crew.kickoff()

# ğŸ“¢ Print Final Validated Data
print(f"âœ… User Data Saved: {save_output_task.output.raw}")
```
âœ” **Executes multiple tasks sequentially.**  
âœ” **Ensures all user inputs are valid before saving.**  

---

# ğŸ“Œ **Final Summary**
âœ… **Data Format Validation** â€“ Ensures correct email & phone formats.  
âœ… **Content Filtering** â€“ Prevents sensitive data from being leaked.  
âœ… **Data Transformation** â€“ Normalizes phone numbers for consistency.  
âœ… **Chaining Validations** â€“ Combines multiple validation steps.  
âœ… **Retry Logic** â€“ Retries tasks when data is invalid.  
âœ… **Auto Directory Creation** â€“ Ensures organized file storage.  

---

# ğŸ”¥ **Next Steps**
ğŸ”¹ **Want to extend this project?**  
1ï¸âƒ£ Add **real-time API validation** using external services.  
2ï¸âƒ£ Implement **database storage** instead of text files.  
3ï¸âƒ£ Build a **web interface** using React or Next.js for user input.  

Let me know how you'd like to proceed! ğŸš€